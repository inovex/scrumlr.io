# Checks if deployed dev-cluster is reachable from public users

name: Check PR dev cluster reachability
on:
  workflow_call:
    inputs:
      base_url:
        required: true
        description: "Base URL to test against"
        type: string

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check reachability of deployed dev cluster
        id: wait-for-cluster
        env:
          BASE_URL: ${{ inputs.base_url }}
        run: |
          retries=0
          success=false
          max_retries=3
          until [ $retries -ge $max_retries ]
          do
            response=$(curl -s -k -o /dev/null -w "%{http_code}" "$BASE_URL/api/health")
            if [ "$response" = "204" ]; then
              echo "Cluster is healthy! Continuing..."
              success=true
              break
            else
              echo "Cluster is not responding. Retrying in $((5 * retries)) seconds..."
              sleep $((5 * retries))
            fi
            retries=$((retries + 1))
          done
          if [ success = false ]; then
            echo "Cluster is still not responding after retries. Exiting..."
            echo "::error title=ClusterNotReachable::Cluster is not responding after $max_retries attempts. HTTP-Code: $response"
            exit 1
          fi