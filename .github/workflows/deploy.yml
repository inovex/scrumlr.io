name: Deployment
on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types: 
      - completed
jobs:
   deploy-pr:
    name: Deploy Feature Branch
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request'}}
    steps:
      - name: generate values-dev.yaml
        run: |
          PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')
          cat > values-dev.yaml << EOF
          hostname: $pr_mumber.scrumlr.fra.ics.inovex.io
          cert:
            enabled: true
            name: scrumlr-cert-$pr_number
          frontend:
            image: registry.kube.com/scrumlr-frontend:$pr_number
            imagePullPolicy: Always
          livequery:
            image: registry.kube.com/scrumlr-server:$pr_number
            imagePullPolicy: Always
          server:
            image: registry.kube.com/scrumlr-server:$pr_number
            imagePullPolicy: Always
          dashboard:
            image: registry.kube.com/scrumlr-dashboard:$pr_number
            imagePullPolicy: Always
          EOF 
      - name: deploy pr 
        run: |
          kubectl get po -n scrumlr-$PR_NUMBER  | grep 'Running\|Completed' && helm uninstall scrumlr-$PR_NUMBER
          kubectl wait --for=delete namespace/scrumlr-$PR_NUMBER --timeout=60s
          helm install scrumlr-$PR_NUMBER ./deployment/chart -f dev.yaml --namespace scrumlr-$PR_NUMBER --create-namespace
    deploy-main:
      name: Deploy Main Branch 
      runs-on: self-hosted
      if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push'}}
      steps:
        - name: deploy main
          run: |
            helm uninstall scrumlr-main
            kubectl wait --for=delete namespace/scrumlr-main --timeout=60s
            helm install scrumlr-main ./deployemnt/chart -f ./deployment/chart/env/dev.yaml
